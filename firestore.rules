rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES AUXILIARES ---
    
    // Verificar si es administrador (Usando Custom Claims)
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.admin == true || 
        request.auth.token.email.matches('.*@buencorte[.]co')
      );
    }
    
    // Verificar si está autenticado
    function isAuth() {
      return request.auth != null;
    }

    // Validar datos de pedido (Sanitización Básica)
    function isValidOrder() {
        // Ejemplo de validación: Debe tener items y total > 0
        return request.resource.data.totalAmount is number && 
               request.resource.data.totalAmount > 0 &&
               request.resource.data.items is list &&
               request.resource.data.items.size() > 0;
    }

    // --- REGLAS POR COLECCIÓN ---

    // Configuración General (Footer/CMS)
    // Lectura: PÚBLICA / Escritura: SOLO ADMIN
    match /general_config/{document} {
      allow read: if true;
      allow write: if isAdmin(); 
    }

    // Usuarios: Solo el propio usuario accede a su info
    match /users/{userId} {
      allow read, write: if isAuth() && request.auth.uid == userId;
    }

    // Pedidos: Lectura pública limitada, escritura solo vía API (Admin SDK)
    // Los clientes pueden crear pedidos vía API autenticada
    match /orders/{orderId} {
      allow read: if isAdmin() || (isAuth() && request.auth.uid == resource.data.userId);
      allow create: if false; // Solo vía Admin SDK desde API
      allow update, delete: if isAdmin();
    }
    
    // Productos: Lectura pública, escritura solo admin
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Experiencias/Comentarios: Lectura pública, escritura autenticada, moderación admin
    match /experiences/{experienceId} {
      allow read: if true;
      allow create: if isAuth();
      allow update, delete: if isAdmin();
    }
    
    // Tickets de Venta (Histórico)
    match /tickets/{ticketId} {
        allow read, write: if isAdmin();
    }

    // ✅ SECURITY: Auditoría de Seguridad (Escritura solo vía Admin SDK)
    match /security_audits/{auditId} {
      allow read, write: if false; 
    }

    // ✅ PHASE 2: Immutable Admin Audit Logs
    match /admin_audit_logs/{logId} {
      allow read: if isAdmin();
      allow create, update, delete: if false; // Solo vía Admin SDK (Firebase Admin en API)
    }

    // Regla por defecto: BLOQUEO TOTAL (Zero Trust)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
