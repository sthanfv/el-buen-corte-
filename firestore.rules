rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES AUXILIARES ---
    
    // Verificar si es administrador (Email corporativo o específico)
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email.matches('.*@buencorte[.]co') || 
        request.auth.token.email == 'fv9316@gmail.com'
      );
    }
    
    // Verificar si está autenticado
    function isAuth() {
      return request.auth != null;
    }

    // Validar datos de pedido (Sanitización Básica)
    function isValidOrder() {
        // Ejemplo de validación: Debe tener items y total > 0
        return request.resource.data.totalAmount is number && 
               request.resource.data.totalAmount > 0 &&
               request.resource.data.items is list &&
               request.resource.data.items.size() > 0;
    }

    // --- REGLAS POR COLECCIÓN ---

    // Configuración General (Footer/CMS)
    // Lectura: PÚBLICA / Escritura: SOLO ADMIN
    match /general_config/{document} {
      allow read: if true;
      allow write: if isAdmin(); 
    }

    // Usuarios: Solo el propio usuario accede a su info
    match /users/{userId} {
      allow read, write: if isAuth() && request.auth.uid == userId;
    }

    // Productos: Catálogo público, gestión protegida
    match /products/{productId} {
      allow read: if true; 
      allow write: if isAdmin();
    }

    // Pedidos: Creación pública (Clientes), Gestión protegida (Admin)
    match /orders/{orderId} {
      // ✅ SECURITY: Solo permitir creación si proviene de la API y pasa validación
      allow create: if request.resource.data._source == "api" && isValidOrder();
      
      // Solo admin puede leer/editar todos los pedidos
      allow read, update, delete: if isAdmin();
    }
    
    // Tickets de Venta (Histórico)
    match /tickets/{ticketId} {
        allow read, write: if isAdmin();
    }

    // ✅ SECURITY: Auditoría de Seguridad (Escritura solo vía Admin SDK)
    match /security_audits/{auditId} {
      allow read, write: if false; 
    }

    // Regla por defecto: BLOQUEO TOTAL (Zero Trust)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
